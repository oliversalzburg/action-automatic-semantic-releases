name: Pre-Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      wants-github-release:
        default: false
        description: Create a GitHub release?
        required: false
        type: boolean

concurrency: pre-release

env:
  DEV_BUILD: true

jobs:
  qa:
    name: ðŸ”¹ QA
    permissions:
      contents: read
      packages: read
    uses: oliversalzburg/workflows/.github/workflows/qa-github-action-nodejs.yml@main

  test:
    if: false
    permissions:
      contents: write
      pull-requests: read

    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Generate release
        uses: ./
        with:
          automatic-release-tag: latest
          changelog-artifact: changelog.json
          draft: true
          dry-run: true
          files: "**/*"
          merge-similar: true
          prerelease: true
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          title: Test Build
          with-authors: false

      - name: Store Changelog
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: changelog.json
          path: changelog.json

  pre-release:
    name: ðŸ”¹ Publish
    needs: qa
    permissions:
      contents: write
      id-token: write
      packages: write
      pages: write
      pull-requests: read
    uses: oliversalzburg/workflows/.github/workflows/publish-github-action-nodejs.yml@main
    with:
      draft-only: false
      is-canary: true
      wants-github-release: ${{ inputs.wants-github-release || false }}
